<div class="p-4 sm:p-6 bg-gray-100 ml-0 sm:ml-64">

    <!-- Encabezado -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 sm:gap-6 mb-6">
        <div class="w-full sm:w-auto flex-1">
            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 sm:gap-6">
                <div>
                    <h2 class="text-2xl sm:text-3xl font-bold text-[#44509D] whitespace-nowrap">
                        Postulaciones
                    </h2>
                    <p class="text-sm text-gray-500" *ngIf="activeTab==='list'">Total: {{ total }}</p>
                    <p class="text-sm text-gray-500" *ngIf="activeTab==='detail'">Detalle</p>
                </div>

                <!-- Filtros solo en LISTA -->
                <ng-container *ngIf="activeTab==='list'">
                    <div class="relative w-full sm:w-80">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                                    clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <input type="text" [(ngModel)]="terminoBusqueda" (input)="onInputBuscar()" class="block w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-[#44509D] focus:border-transparent transition" placeholder="Buscar por nombre, email..."
                        />
                    </div>

                    <div>
                        <select [(ngModel)]="filtroEstatus" (change)="onChangeFiltros()" class="block w-full sm:w-56 px-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#44509D]">
                            <option *ngFor="let e of estatusOpciones" [ngValue]="e.id">{{ e.label }}</option>
                        </select>
                    </div>
                </ng-container>

                <!-- Back solo en DETALLE -->
                <button *ngIf="activeTab==='detail'" (click)="volverAlListado()" class="px-3 py-2 rounded-lg border bg-white hover:bg-gray-50 text-sm">
                    ← Volver al listado
                </button>
            </div>
        </div>
    </div>

    <!-- LISTA -->
    <ng-container *ngIf="activeTab==='list'">
        <!-- Skeleton LISTA -->
        <div *ngIf="cargando" class="animate-pulse">
            <div class="w-full overflow-x-auto">
                <div class="inline-block min-w-full align-middle rounded-md border border-gray-200">
                    <table class="min-w-full bg-white border rounded-md shadow-md text-sm">
                        <thead class="bg-[#44509D] text-white">
                            <tr>
                                <th class="px-3 py-3 text-left">ID</th>
                                <th class="px-3 py-3 text-left">Fecha</th>
                                <th class="px-3 py-3 text-left">Nombre</th>
                                <th class="px-3 py-3 text-left">Email</th>
                                <th class="px-3 py-3 text-left">Estatus</th>
                                <th class="px-3 py-3 text-left">Acción</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <tr *ngFor="let i of [1,2,3,4,5]">
                                <td class="px-3 py-3">
                                    <div class="h-4 w-8 bg-gray-200 rounded"></div>
                                </td>
                                <td class="px-3 py-3">
                                    <div class="h-4 w-20 bg-gray-200 rounded"></div>
                                </td>
                                <td class="px-3 py-3">
                                    <div class="h-4 w-32 bg-gray-200 rounded"></div>
                                </td>
                                <td class="px-3 py-3">
                                    <div class="h-4 w-40 bg-gray-200 rounded"></div>
                                </td>
                                <td class="px-3 py-3">
                                    <div class="h-4 w-24 bg-gray-200 rounded"></div>
                                </td>
                                <td class="px-3 py-3 text-center">
                                    <div class="h-6 w-16 bg-gray-200 rounded"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div *ngIf="!cargando && errorMsg" class="text-center text-red-600 py-8">{{ errorMsg }}</div>

        <div *ngIf="!cargando" class="w-full overflow-x-auto">
            <div class="inline-block min-w-full align-middle rounded-md border border-gray-200">
                <table class="min-w-full bg-white border rounded-md shadow-md text-sm">
                    <thead class="bg-[#44509D] text-white">
                        <tr>
                            <th class="px-3 py-3 text-left font-medium uppercase tracking-wider">ID</th>
                            <th class="px-3 py-3 text-left font-medium uppercase tracking-wider whitespace-nowrap cursor-pointer" (click)="cambiarOrden('p.docente_created_at')">Fecha</th>
                            <th class="px-3 py-3 text-left font-medium uppercase tracking-wider">Nombre</th>
                            <th class="px-3 py-3 text-left font-medium uppercase tracking-wider">Email</th>
                            <th class="px-3 py-3 text-left font-medium uppercase tracking-wider">Estatus</th>
                            <th class="px-3 py-3 text-center font-medium uppercase tracking-wider">Acción</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        <tr *ngFor="let p of postulacionesFiltradas" class="hover:bg-gray-50 transition">
                            <td class="px-3 py-3 text-gray-700 text-center">{{ p.docente_id }}</td>
                            <td class="px-3 py-3 text-gray-700 text-center">{{ p.docente_created_at | date:'dd/MM/yyyy HH:mm' }}</td>
                            <td class="px-3 py-3 font-medium text-gray-800">{{ p.nombre }} {{ p.apellidos }}</td>
                            <td class="px-3 py-3 text-gray-700">{{ p.email }}</td>
                            <td class="px-3 py-3">
                                <span class="px-2 py-1 rounded-full text-xs font-medium" [ngClass]="{
                  'bg-green-100 text-green-700': p.estatus_id === 4,
                  'bg-red-100 text-red-700': p.estatus_id === 5 || p.estatus_id === 7,
                  'bg-yellow-100 text-yellow-700': p.estatus_id === 6
                }">{{ p.estatus_valor }}</span>
                            </td>
                            <td class="px-3 py-3 text-center">
                                <button (click)="verDetalles(p)" class="bg-indigo-600 text-white px-2 py-1 rounded text-xs hover:bg-indigo-700 transition">
                                    Mostrar detalles
                                </button>
                            </td>
                        </tr>

                        <tr *ngIf="!postulacionesFiltradas.length">
                            <td colspan="6" class="px-3 py-6 text-center text-gray-500">Sin resultados.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Paginación -->
        <div class="flex items-center justify-between mt-4" *ngIf="total > 0">
            <div class="text-sm text-gray-600">
                Mostrando {{ offset + 1 }}–{{ Math.min(offset + limit, total) }} de {{ total }}
            </div>
            <div class="flex gap-2">
                <button (click)="cambiarPagina('prev')" [disabled]="offset === 0" class="px-3 py-1.5 rounded border bg-white hover:bg-gray-50 disabled:opacity-50">Anterior</button>
                <button (click)="cambiarPagina('next')" [disabled]="offset + limit >= total" class="px-3 py-1.5 rounded border bg-white hover:bg-gray-50 disabled:opacity-50">Siguiente</button>
            </div>
        </div>
    </ng-container>



    <!-- DETALLE -->
    <ng-container *ngIf="activeTab==='detail'">
        <!-- Skeleton DETALLE -->
        <!-- Skeleton DETALLE -->
        <div *ngIf="cargando" class="animate-pulse">
            <div class="rounded-2xl border border-gray-200 bg-white p-5 shadow-sm">

                <!-- Feedback simulado -->
                <div class="mb-3 h-8 w-full bg-gray-200 rounded"></div>

                <!-- Header: Identidad + Estatus -->
                <div class="flex items-start justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <div class="h-14 w-14 rounded-xl bg-gray-200"></div>
                        <div>
                            <div class="h-4 w-40 bg-gray-200 rounded mb-2"></div>
                            <div class="h-3 w-32 bg-gray-200 rounded"></div>
                            <div class="h-3 w-24 bg-gray-200 rounded mt-1"></div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="h-5 w-20 bg-gray-200 rounded-full ml-auto mb-2"></div>
                        <div class="h-3 w-28 bg-gray-200 rounded mb-1 ml-auto"></div>
                        <div class="h-3 w-24 bg-gray-200 rounded ml-auto"></div>
                    </div>
                </div>

                <!-- Chips de estado -->
                <div class="mt-4 flex flex-wrap gap-2">
                    <div class="h-5 w-24 bg-gray-200 rounded-full"></div>
                    <div class="h-5 w-28 bg-gray-200 rounded-full"></div>
                    <div class="h-5 w-20 bg-gray-200 rounded-full"></div>
                    <div class="h-5 w-28 bg-gray-200 rounded-full"></div>
                </div>

                <!-- Bloque: Asignar contraseña -->
                <div class="mt-6">
                    <div class="h-4 w-32 bg-gray-200 rounded mb-3"></div>
                    <div class="h-10 w-full bg-gray-200 rounded mb-2"></div>
                    <div class="h-2 w-full bg-gray-200 rounded mb-1"></div>
                    <div class="h-2 w-2/3 bg-gray-200 rounded"></div>
                </div>
            </div>
        </div>

        <div *ngIf="!cargando" class="mx-auto">
            <!-- feedback -->
            <div *ngIf="selectedId && actionResponses.get(selectedId) as resp" class="mb-3 text-sm rounded border px-3 py-2" [ngClass]="{
        'border-green-200 text-green-700 bg-green-50': resp.type==='success',
        'border-yellow-200 text-yellow-700 bg-yellow-50': resp.type==='warning',
        'border-red-200 text-red-700 bg-red-50': resp.type==='error'
      }">
                {{ resp.message }}
            </div>

            <!-- tarjeta principal -->
            <div class="rounded-2xl border border-gray-200 bg-white p-5 shadow-sm">
                <!-- Header: Identidad + Estatus -->
                <div class="flex items-start justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <!-- Avatar -->
                        <img *ngIf="detalle?.foto_url; else avatarFallback" [src]="detalle?.foto_url" alt="Foto de {{ detalle?.nombre }}" class="h-14 w-14 rounded-xl object-cover border border-gray-200" />
                        <ng-template #avatarFallback>
                            <div class="h-14 w-14 rounded-xl bg-gray-100 text-gray-600 grid place-content-center border border-gray-200" aria-hidden="true">
                                <span class="text-lg font-semibold">
                                    {{ (detalle?.nombre?.[0] || 'U') + (detalle?.apellidos?.[0] || '') }}
                                </span>
                            </div>
                        </ng-template>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">
                                {{ detalle?.nombre }} {{ detalle?.apellidos }}
                            </h3>
                            <p class="text-sm text-gray-600">
                                <a class="hover:underline" [href]="'mailto:'+detalle?.email">{{ detalle?.email }}</a> • {{ detalle?.telefono || '—' }}
                            </p>
                            <p class="text-xs text-gray-500" *ngIf="detalle?.especialidad">
                                Especialidad: {{ detalle?.especialidad }}
                            </p>
                        </div>
                    </div>

                    <div class="text-right">
                        <span class="px-2 py-1 rounded-full text-xs font-medium" [ngClass]="{
              'bg-green-100 text-green-700': detalle?.estatus_id === 4,
              'bg-red-100 text-red-700': detalle?.estatus_id === 5 || detalle?.estatus_id === 7,
              'bg-yellow-100 text-yellow-700': detalle?.estatus_id === 6
            }">
                            {{ detalle?.estatus_valor }}
                        </span>
                        <div class="mt-2 text-xs text-gray-500">
                            <div>Creado: {{ detalle?.created_at | date:'dd/MM/yyyy HH:mm:ss':'UTC' }}</div>
                            <div>Actualizado: {{ detalle?.updated_at | date:'dd/MM/yyyy HH:mm:ss':'UTC' }}</div>
                        </div>

                    </div>
                </div>

                <!-- Chips de estado del usuario -->
                <div class="mt-4 flex flex-wrap items-center gap-2">
                    <!-- Activo/Inactivo -->
                    <span class="px-2 py-1 rounded-full text-xs font-medium" [ngClass]="badge(detalle?.usuario_activo)">
                        {{ detalle?.usuario_activo ? 'Usuario activo' : 'Usuario inactivo' }}
                    </span>

                    <!-- Correo validado (corrige el nombre del campo) -->
                    <span class="px-2 py-1 rounded-full text-xs font-medium" [ngClass]="badge(detalle?.usuario_correo_validado)">
                        {{ detalle?.usuario_correo_validado ? 'Correo validado' : 'Correo sin validar' }}
                    </span>

                    <span class="px-2 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-700">
                        Rol usuario: {{ detalle?.estatus_tipo || '—' }}
                    </span>

                    <!-- Password -->
                    <span class="px-2 py-1 rounded-full text-xs font-medium" [ngClass]="badge(!detalle?.usuario_password_es_default)">
                        {{ detalle?.usuario_password_es_default ? 'contraseña default' : 'Password personalizada' }}
                    </span>
                </div>

                <div class="summary-box rounded-lg p-4 mb-6 flex items-start bg-blue-50 border border-blue-100 mt-3">
                    <!-- <div class="bg-blue-100 p-3 rounded-full mr-4">
                        <i class="fas fa-info-circle text-blue-600 text-xl"></i>
                    </div> -->
                    <div>
                        <h2 class="font-semibold text-blue-800 mb-1">Estado del perfil-</h2>
                        <p class="text-blue-600">
                            <!-- Lógica corregida para mostrar el estado correcto -->
                            {{ detalle?.usuario_activo ? (detalle?.usuario_password_es_default ? 'Usuario activo pero debe cambiar su contraseña predeterminada' : 'Usuario activo con acceso al sistema') : 'Usuario inactivo Sin acceso al sistema' }}
                        </p>


                    </div>
                </div>


                <!-- Botón inicial -->
                <div class="mt-6" *ngIf="!editandoPass">
                    <button class="px-4 py-2 rounded bg-indigo-600 text-white text-sm hover:bg-indigo-700" (click)="editandoPass = true">
                        Editar contraseña
                    </button>
                </div>

                <!-- Bloque: Asignar contraseña -->
                <div class="mt-6" *ngIf="editandoPass">
                    <div class="text-sm font-medium text-gray-800 mb-2">Asignar contraseña</div>

                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 w-full">
                        <div class="relative w-full sm:w-80">
                            <input [type]="showPass ? 'text' : 'password'" [(ngModel)]="newPassword" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm pr-10" placeholder="Nueva contraseña (mín. 8 caracteres)" />
                            <button type="button" class="absolute inset-y-0 right-0 px-3 text-xs text-gray-600 hover:text-gray-900" (click)="showPass = !showPass" [attr.aria-label]="showPass ? 'Ocultar contraseña' : 'Mostrar contraseña'">
                                {{ showPass ? 'Ocultar' : 'Mostrar' }}
                            </button>
                        </div>

                        <button (click)="asignarPassword()" class="px-3 py-2 rounded bg-indigo-600 text-white text-xs hover:bg-indigo-700 disabled:opacity-50" [disabled]="isLoading(selectedId!) || !canAssignPass()">
                            Asignar
                        </button>

                        <!-- Cancelar edición -->
                        <button type="button" class="px-3 py-2 rounded bg-gray-200 text-gray-700 text-xs hover:bg-gray-300" (click)="cancelarEdicion()">
                            Cancelar
                        </button>
                    </div>

                    <!-- Indicador de fuerza -->
                    <div class="mt-2 w-full sm:w-80">
                        <div class="h-2 w-full rounded bg-gray-200 overflow-hidden">
                            <div class="h-2" [ngClass]="strengthBarClass()" [style.width.%]="passwordStrength() * 25">
                            </div>
                        </div>
                        <div class="mt-1 text-xs text-gray-600">Fortaleza: {{ strengthLabel() }}</div>
                    </div>

                    <p class="text-xs text-gray-500 mt-2">
                        Usa “Asignar” para establecer una contraseña manual (mínimo 8 caracteres).
                    </p>
                </div>

            </div>
        </div>
    </ng-container>

</div>